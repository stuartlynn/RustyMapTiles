<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8' />
  <title>Add a vector tile source</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.4.1/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.4.1/mapbox-gl.css' rel='stylesheet' />
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }

    .boxdraw {
      background: rgba(56, 135, 190, 0.1);
      border: 2px solid #3887be;
      position: absolute;
      top: 0;
      left: 0;
      width: 0;
      height: 0;
    }
  </style>
</head>

<body>

  <div id='map'></div>
  <script>
    mapboxgl.accessToken = 'pk.eyJ1Ijoic3R1YXJ0LWx5bm4iLCJhIjoiM2Q4ODllNmRkZDQ4Yzc3NTBhN2UyNDE0MWY2OTRiZWIifQ.8OEKvgZBCCtDFUXkjt66Pw';
    var map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/light-v10',
      zoom: 13,
      center: [-73.9920330193022, 40.75078660435196]
    });

    map.on('load', function () {
      var canvas = map.getCanvasContainer();

      map.boxZoom.disable();

      // Variable to hold the starting xy coordinates
      // when `mousedown` occured.
      var start;

      // Variable to hold the current xy coordinates
      // when `mousemove` or `mouseup` occurs.
      var current;

      // Variable for the draw box element.
      var box;

      canvas.addEventListener('mousedown', mouseDown, true);

      function mousePos(e) {
        var rect = canvas.getBoundingClientRect();
        return new mapboxgl.Point(
          e.clientX - rect.left - canvas.clientLeft,
          e.clientY - rect.top - canvas.clientTop
        );
      }

      function mouseDown(e) {
        // Continue the rest of the function if the shiftkey is pressed.
        if (!(e.shiftKey && e.button === 0)) return;

        // Disable default drag zooming when the shift key is held down.
        map.dragPan.disable();

        // Call functions for the following events
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
        document.addEventListener('keydown', onKeyDown);

        // Capture the first xy coordinates
        start = mousePos(e);
      }

      map.addSource(
        'census_tracts',
        {
          type: 'vector',
          tiles: ["http://localhost:8000/tracts/{z}/{x}/{y}"],
          minzoom: 0,
          maxzoom: 9
        }
      )

      function onMouseMove(e) {
        // Capture the ongoing xy coordinates
        current = mousePos(e);

        // Append the box element if it doesnt exist
        if (!box) {
          box = document.createElement('div');
          box.classList.add('boxdraw');
          canvas.appendChild(box);
        }

        var minX = Math.min(start.x, current.x),
          maxX = Math.max(start.x, current.x),
          minY = Math.min(start.y, current.y),
          maxY = Math.max(start.y, current.y);

        // Adjust width and xy position of the box element ongoing
        var pos = 'translate(' + minX + 'px,' + minY + 'px)';
        box.style.transform = pos;
        box.style.WebkitTransform = pos;
        box.style.width = maxX - minX + 'px';
        box.style.height = maxY - minY + 'px';
      }

      function onMouseUp(e) {
        // Capture xy coordinates
        finish([start, mousePos(e)]);
      }


      function onKeyDown(e) {
        // If the ESC key is pressed
        if (e.keyCode === 27) finish();
      }

      function finish(bbox) {
        // Remove these events now that finish has been called.
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('keydown', onKeyDown);
        document.removeEventListener('mouseup', onMouseUp);

        if (box) {
          box.parentNode.removeChild(box);
          box = null;
        }

        // If bbox exists. use this value as the argument for `queryRenderedFeatures`
        if (bbox) {
          var features = map.queryRenderedFeatures(bbox, { layers: ['census_blocks_fill'] });

          if (features.length >= 1000) {
            return window.alert('Select a smaller number of features');
          }

          // Run through the selected features and set a filter
          // to match features with unique FIPS codes to activate
          // the `counties-highlighted` layer.
          var ids = features.map(f => f.properties.id)
          console.log('selected ', ids)

          fetch(`/od_multi/work/${ids.join(",")}`).then(r => r.json()).then(apply_results)

          // map.setFilter("counties-highlighted", filter);
        }

        map.dragPan.enable();
      }

      map.on('mousemove', function (e) {
        // var features = map.queryRenderedFeatures(e.point, { layers: ['counties-highlighted'] });
        // Change the cursor style as a UI indicator.
        // map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';

        // if (!features.length) {
        //   popup.remove();
        //   return;
        // }

        // var feature = features[0];
      });


      map.addSource(
        'census_blocks',
        {
          type: 'vector',
          tiles: ["http://localhost:8000/blocks/{z}/{x}/{y}"],
          minzoom: 10,
          maxzoom: 20
        }
      );

      console.log('adding source blocks');
      map.addLayer(
        {
          id: "census_tract_poly",
          type: "fill",
          source: 'census_tracts',
          "source-layer": "tracts",
          "paint": {
            "fill-opacity": 0.0,
            "fill-color": "#ff69b4",
          }
        }, 'waterway-label');

      map.addLayer(
        {
          id: "census_tract_line",
          type: "line",
          source: 'census_tracts',
          "source-layer": "tracts",
          "paint": {
            "line-opacity": 0.0,
            "line-color": "#000000",
          }
        }, 'census_tract_poly');


      const block_fill = map.addLayer(
        {
          id: "census_blocks_fill",
          type: "fill",
          source: 'census_blocks',
          "source-layer": 'blocks',
          paint: {
            "fill-opacity": 0.3,
            "fill-color": ["match", ["get", "id"], "360610113001003", "rgba(0,0,255,1)", "rgba(0,255,0,1)"]
          }
        }, "census_tract_line")

      map.addLayer(
        {
          id: "census_blocks_line",
          type: "line",
          source: 'census_blocks',
          "source-layer": 'blocks',
          paint: {
            "line-opacity": 0.2,
            "line-color": "#FF0000"
          }
        }, "census_tract_line");

      const apply_results = (result) => {
        console.log('result ', result)
        const maxVal = Math.max(...result.map(r => r.count));
        var expression = ["match", ["get", "id"]]
        // var expression = ["match", ["get", "id"]];

        result.forEach(row => {
          var val = Math.random() * maxVal;

          // var green = (row["count"] / maxVal) * 255;
          var green = (val / maxVal) * 255;

          var color = "rgba(" + 0 + ", " + green + ", " + 0 + ", 1)";
          expression.push(row["id"], color);
        })
        // expression.push(id, "rgba(255,0,0,1)")
        expression.push("rgba(0,0,0,0)");
        console.log(expression)
        map.setPaintProperty('census_blocks_fill', 'fill-color', expression);
        map.triggerRepaint()
      }
      map.on('click', 'census_blocks_fill', function (e) {
        const id = e.features[0].properties.id;
        console.log(e.features[0])
        fetch(`/od/work/${id}`).then(j => j.json()).then(apply_results)
      });


    });
  </script>

</body>

</html>